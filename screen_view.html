<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Screen Stream</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è body –∏ html */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #181818;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç–∫—Ä–∞–Ω */
        #screen {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
            display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ */
            transition: opacity 0.2s ease-in-out; /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞ */
        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10;
            transition: color 0.3s, background-color 0.3s;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
        #initial-message {
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- –≠–ª–µ–º–µ–Ω—Ç, –∫—É–¥–∞ –±—É–¥–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å—Å—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è -->
    <img id="screen" src="" alt="–≠–∫—Ä–∞–Ω –ü–ö"/>
    
    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ -->
    <div id="initial-message">
        <h1>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞</h1>
        <p>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é" –≤ –ü–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div id="status">‚ö™ –û–∂–∏–¥–∞–Ω–∏–µ...</div>

    <script>
        // ### –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π WSS –∞–¥—Ä–µ—Å –æ—Ç ngrok ###
        const NGROK_WSS_URL = "wss://your-ngrok-address.ngrok-free.dev";  
        // ### ---------------------------------------------------------------- ###

        // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã
        const statusElement = document.getElementById('status');
        const screenElement = document.getElementById('screen');
        const initialMessageElement = document.getElementById('initial-message');
        let socket;

        /**
         * –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
         */
        function connect() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            statusElement.textContent = 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            statusElement.style.color = '#fdd835';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            const fullUrl = NGROK_WSS_URL + "/stream";
            console.log(`Connecting to ${fullUrl}`);

            try {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π WebSocket –æ–±—ä–µ–∫—Ç
                socket = new WebSocket(fullUrl);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                socket.onopen = function() {
                    console.log("Connection established.");
                    statusElement.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    statusElement.style.color = '#76ff7a';
                };

                /**
                 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è: –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
                 * –≠—Ç–æ—Ç –±–ª–æ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏—Ö–æ–¥—è—â–∏–µ –∫–∞–∫ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ (string),
                 * —Ç–∞–∫ –∏ –≤ –≤–∏–¥–µ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (Blob), —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É.
                 */
                socket.onmessage = function(event) {
                    const processImage = (base64String) => {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
                        screenElement.src = 'data:image/jpeg;base64,' + base64String;
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç img –∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                        if (screenElement.style.display === 'none') {
                            screenElement.style.display = 'block';
                            initialMessageElement.style.display = 'none';
                        }
                    };

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–æ–º Blob
                    if (event.data instanceof Blob) {
                        const reader = new FileReader();
                        // –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ Blob –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—á–∏—Ç–∞–Ω
                        reader.onload = function() {
                            // reader.result —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ Data URL (e.g., "data:image/jpeg;base64,...")
                            // –û—Ç–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–∞–º—É base64-—Å—Ç—Ä–æ–∫—É
                            const base64Data = this.result.split(',')[1];
                            processImage(base64Data);
                        };
                        // –ù–∞—á–∏–Ω–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ Blob –∫–∞–∫ Data URL
                        reader.readAsDataURL(event.data);
                    } else {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –ø—Ä–∏—à–ª–∏ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö –Ω–∞–ø—Ä—è–º—É—é
                        processImage(event.data);
                    }
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
                socket.onclose = function(event) {
                    console.log('Connection closed. Code: ' + event.code);
                    statusElement.textContent = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
                    statusElement.style.color = '#ff7676';
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    screenElement.style.display = 'none';
                    initialMessageElement.style.display = 'block';
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(connect, 3000);
                };

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è: –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                socket.onerror = function(error) {
                    console.error('WebSocket Error:', error);
                    statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞';
                    statusElement.style.color = '#ff7676';
                };

            } catch (e) {
                console.error("Failed to create WebSocket:", e);
                statusElement.textContent = '‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞';
                statusElement.style.color = '#ff7676';
            }
        }
        
        // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ
        Telegram.WebApp.ready();
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        connect();

    </script>
</body>
</html>
